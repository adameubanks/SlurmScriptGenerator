<!DOCTYPE html>
<html>
<head>
    <title>Job Script Generator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f9f9f9;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            text-align: left;
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
        }
        .form-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .form-row label {
            flex: 1;
        }
        .form-row input, .form-row select {
            flex: 2;
        }
        .btn-container {
            text-align: center;
        }
        .btn {
            display: inline-block;
            padding: 10px 20px;
            font-size: 16px;
            color: #fff;
            background-color: #007bff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
        }
        .btn:hover {
            background-color: #0056b3;
        }
        .dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f1f1f1;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
            z-index: 1;
        }
        .dropdown-content label {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
        }
        .dropdown-content label:hover {
            background-color: #ddd;
        }
        .dropdown:hover .dropdown-content {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Job Script Generator</h1>
        <div id="form-container"></div>
        <div class="btn-container">
            <button class="btn" onclick="generateScript()">Generate Script</button>
        </div>
        <div class="dropdown">
            <button class="btn dropdown-button">Features</button>
            <div class="dropdown-content">
                <div class="dropdown-menu"></div>
            </div>
        </div>
    </div>

    <script>
        var uvaScriptGen = function(div) {
            this.values = {};
            this.containerDiv = div;
            this.inputs = {};
            this.inputs.features = {};
            this.formrows = [];
            this.settings = {
                script_formats: [["slurm", "Slurm"], ["pbs", "PBS"]],
                defaults: {
                    email_address: "myemail@example.com",
                },
                qos: {
                    preemptable: "standby",
                    test: "test"
                },
                features: {},
                features_status: {},
                partitions: {},
                partitions_status: {},
            };
            return this;
        };

        uvaScriptGen.prototype.returnNewRow = function(rowid, left, right) {
            var l, r, tr;
            l = document.createElement("td");
            r = document.createElement("td");
            tr = document.createElement("tr");
            l.id = rowid + "_left";
            r.id = rowid + "_right";
            tr.id = rowid;
            l.innerHTML = left;
            r.appendChild(right);
            tr.appendChild(l);
            tr.appendChild(r);
            return tr;
        };

        uvaScriptGen.prototype.newCheckbox = function(args) {
            var tthis = this;
            var newEl = document.createElement("input");
            newEl.type = "checkbox";
            var formrows = this.formrows;
            if (args.checked) newEl.checked = true;
            if (args.toggle)
                newEl.onclick = newEl.onchange = function() {
                    formrows[args.toggle].style.display = newEl.checked ? "" : "none";
                    tthis.updateJobscript();
                };
            else
                newEl.onclick = newEl.onchange = function() {
                    tthis.updateJobscript();
                };
            return newEl;
        };

        uvaScriptGen.prototype.newInput = function(args) {
            var tthis = this;
            var newEl = document.createElement("input");
            newEl.type = "text";
            if (args.size) newEl.size = args.size;
            if (args.maxLength) newEl.maxLength = args.maxLength;
            if (args.value) newEl.value = args.value;
            newEl.onclick = newEl.onchange = function() {
                tthis.updateJobscript();
            };
            return newEl;
        };

        uvaScriptGen.prototype.newSelect = function(args) {
            var tthis = this;
            var newEl = document.createElement("select");
            if (args.options) {
                for (var i in args.options) {
                    var newOpt = document.createElement("option");
                    newOpt.value = args.options[i][0];
                    newOpt.text = args.options[i][1];
                    if (args.selected && args.selected == args.options[i][0])
                        newOpt.selected = true;
                    newEl.appendChild(newOpt);
                }
            }
            newEl.onclick = newEl.onchange = function() {
                tthis.updateJobscript();
            };
            return newEl;
        };

        uvaScriptGen.prototype.newSpan = function() {
            var newEl = document.createElement("span");
            if (arguments[0]) newEl.id = arguments[0];
            for (var i = 1; i < arguments.length; i++) {
                if (typeof arguments[i] == "string") {
                    newEl.appendChild(document.createTextNode(arguments[i]));
                } else newEl.appendChild(arguments[i]);
            }
            return newEl;
        };

        uvaScriptGen.prototype.newA = function(url, body) {
            var a = document.createElement("a");
            a.href = url;
            a.appendChild(document.createTextNode(body));
            a.target = "_base";
            return a;
        };

        uvaScriptGen.prototype.createForm = function(doc) {
            function br() {
                return document.createElement("br");
            }

            function newHeaderRow(text) {
                var headertr = document.createElement("tr");
                var headerth = document.createElement("th");
                headerth.colSpan = 2;
                headerth.appendChild(document.createTextNode(text));
                headertr.appendChild(headerth);
                return headertr;
            }

            var newEl;
            form = document.createElement("form");
            var table = document.createElement("table");
            form.appendChild(table);
            table.appendChild(newHeaderRow("Parameters"));

            this.inputs.single_node = this.newCheckbox({ checked: 1 });
            this.inputs.num_cores = this.newInput({ value: 1 });
            this.inputs.num_gpus = this.newInput({ value: 0, size: 4 });
            this.inputs.mem_per_core = this.newInput({ value: 1, size: 6 });
            this.inputs.mem_units = this.newSelect({ options: [["GB", "GB"], ["MB", "MB"]] });
            this.inputs.wallhours = this.newInput({ value: "1", size: 3 });
            this.inputs.wallmins = this.newInput({ value: "00", size: 2, maxLength: 2 });
            this.inputs.wallsecs = this.newInput({ value: "00", size: 2, maxLength: 2 });
            this.inputs.is_test = this.newCheckbox({ checked: 0 });
            this.inputs.is_preemptable = this.newCheckbox({ checked: 0, toggle: "is_requeueable" });

            this.inputs.is_requeueable = this.newCheckbox({ checked: 0 });
            this.inputs.in_group = this.newCheckbox({ checked: 0, toggle: "group_name" });
            this.inputs.group_name = this.newInput({ value: "MYGROUPNAME" });
            this.inputs.need_licenses = this.newCheckbox({ checked: 0, toggle: "licenses" });

            this.inputs.lic0_name = this.newInput({});
            this.inputs.lic0_count = this.newInput({ size: 3, maxLength: 4 });
            this.inputs.lic1_name = this.newInput({});
            this.inputs.lic1_count = this.newInput({ size: 3, maxLength: 4 });
            this.inputs.lic2_name = this.newInput({});
            this.inputs.lic2_count = this.newInput({ size: 3, maxLength: 4 });
            this.inputs.job_name = this.newInput({});
            this.inputs.email_begin = this.newCheckbox({ checked: 0 });
            this.inputs.email_end = this.newCheckbox({ checked: 0 });
            this.inputs.email_abort = this.newCheckbox({ checked: 1 });

            this.inputs.email_address = this.newInput({ size: 40, value: this.settings.defaults.email_address });
            this.inputs.script_format = this.newSelect({ options: this.settings.script_formats });
            this.inputs.script_filename = this.newInput({});
            this.inputs.script_code = this.newSpan("script_code");

            var formrows = [
                this.returnNewRow("single_node", "Single Node Job", this.inputs.single_node),
                this.returnNewRow("num_cores", "Number of cores", this.inputs.num_cores),
                this.returnNewRow("num_gpus", "Number of GPUs", this.inputs.num_gpus),
                this.returnNewRow("mem_per_core", "Memory per core", this.newSpan(this.inputs.mem_per_core, this.inputs.mem_units)),
                this.returnNewRow("wallhours", "Walltime", this.newSpan(this.inputs.wallhours, ":", this.inputs.wallmins, ":", this.inputs.wallsecs)),
                this.returnNewRow("is_test", "Test job", this.inputs.is_test),
                this.returnNewRow("is_preemptable", "Preemptable job", this.inputs.is_preemptable),
                this.returnNewRow("is_requeueable", "Requeueable job", this.inputs.is_requeueable),
                this.returnNewRow("in_group", "Job in group", this.inputs.in_group),
                this.returnNewRow("group_name", "Group Name", this.inputs.group_name),
                this.returnNewRow("need_licenses", "Need Licenses", this.inputs.need_licenses),
                this.returnNewRow("lic0_name", "License 1", this.newSpan(this.inputs.lic0_name, this.inputs.lic0_count)),
                this.returnNewRow("lic1_name", "License 2", this.newSpan(this.inputs.lic1_name, this.inputs.lic1_count)),
                this.returnNewRow("lic2_name", "License 3", this.newSpan(this.inputs.lic2_name, this.inputs.lic2_count)),
                this.returnNewRow("job_name", "Job Name", this.inputs.job_name),
                this.returnNewRow("email_begin", "Email when job begins", this.inputs.email_begin),
                this.returnNewRow("email_end", "Email when job ends", this.inputs.email_end),
                this.returnNewRow("email_abort", "Email if job aborts", this.inputs.email_abort),
                this.returnNewRow("email_address", "Email Address", this.inputs.email_address),
                this.returnNewRow("script_format", "Script format", this.inputs.script_format),
                this.returnNewRow("script_filename", "Script filename", this.inputs.script_filename),
                this.returnNewRow("script_code", "Script code", this.inputs.script_code),
            ];

            for (var i in formrows) table.appendChild(formrows[i]);
            this.formrows = {
                is_requeueable: formrows[7],
                group_name: formrows[9],
                lic0_name: formrows[11],
                lic1_name: formrows[12],
                lic2_name: formrows[13],
            };

            this.containerDiv.appendChild(form);

            if (!this.inputs.is_preemptable.checked)
                this.formrows["is_requeueable"].style.display = "none";
            if (!this.inputs.in_group.checked) this.formrows["group_name"].style.display = "none";
            if (!this.inputs.need_licenses.checked) {
                this.formrows["lic0_name"].style.display = "none";
                this.formrows["lic1_name"].style.display = "none";
                this.formrows["lic2_name"].style.display = "none";
            }
        };

        uvaScriptGen.prototype.updateJobscript = function() {
            var qos;
            if (this.inputs.is_test.checked) qos = this.settings.qos.test;
            else if (this.inputs.is_preemptable.checked) qos = this.settings.qos.preemptable;
            else qos = "normal";

            var values = {
                single_node: this.inputs.single_node.checked ? 1 : 0,
                num_cores: this.inputs.num_cores.value,
                num_gpus: this.inputs.num_gpus.value,
                mem_per_core: this.inputs.mem_per_core.value,
                mem_units: this.inputs.mem_units.value,
                wallhours: this.inputs.wallhours.value,
                wallmins: this.inputs.wallmins.value,
                wallsecs: this.inputs.wallsecs.value,
                is_test: this.inputs.is_test.checked,
                is_preemptable: this.inputs.is_preemptable.checked,
                is_requeueable: this.inputs.is_requeueable.checked,
                in_group: this.inputs.in_group.checked,
                group_name: this.inputs.group_name.value,
                need_licenses: this.inputs.need_licenses.checked,
                lic0_name: this.inputs.lic0_name.value,
                lic0_count: this.inputs.lic0_count.value,
                lic1_name: this.inputs.lic1_name.value,
                lic1_count: this.inputs.lic1_count.value,
                lic2_name: this.inputs.lic2_name.value,
                lic2_count: this.inputs.lic2_count.value,
                job_name: this.inputs.job_name.value,
                email_begin: this.inputs.email_begin.checked,
                email_end: this.inputs.email_end.checked,
                email_abort: this.inputs.email_abort.checked,
                email_address: this.inputs.email_address.value,
                script_format: this.inputs.script_format.value,
                script_filename: this.inputs.script_filename.value,
                qos: qos,
            };

            var script = `#!/bin/bash
#SBATCH --job-name=${values.job_name}
#SBATCH --output=${values.script_filename}
#SBATCH --qos=${values.qos}
#SBATCH --time=${values.wallhours}:${values.wallmins}:${values.wallsecs}
#SBATCH --mem-per-cpu=${values.mem_per_core}${values.mem_units}
#SBATCH --cpus-per-task=${values.num_cores}
#SBATCH --gres=gpu:${values.num_gpus}
#SBATCH --mail-type=BEGIN,END,FAIL
#SBATCH --mail-user=${values.email_address}`;

            this.inputs.script_code.innerText = script;
        };

        function generateScript() {
            generator.updateJobscript();
        }

        var generator = new uvaScriptGen(document.getElementById("form-container"));
        generator.createForm();
    </script>
</body>
</html>
